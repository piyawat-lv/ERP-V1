<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <style>
    body { font-family: 'Sarabun', sans-serif; display: flex; justify-content: center; padding-top: 50px; }
    .card { width: 400px; padding: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-radius: 10px; }
    input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box;}
    button { width: 100%; padding: 12px; background: #FF9800; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem;}
    button:hover { background: #F57C00; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Change Password</h2>
    <input type="password" id="old-pass" placeholder="รหัสผ่านเดิม">
    <input type="password" id="new-pass" placeholder="รหัสผ่านใหม่">
    <input type="password" id="confirm-pass" placeholder="ยืนยันรหัสผ่านใหม่">
    <button id="changePassBtn">Update Password</button>
  </div>

  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    document.getElementById('changePassBtn').addEventListener('click', function() {
      const oldPass = document.getElementById('old-pass').value;
      const newPass = document.getElementById('new-pass').value;
      const confirmPass = document.getElementById('confirm-pass').value;
      
      // ดึง Token ที่เก็บไว้ตอน Login (สำคัญมาก!)
      const token = sessionStorage.getItem('authToken');

      if (!token) { Swal.fire('Error', 'Session หมดอายุ กรุณา Login ใหม่', 'error'); return; }
      if (newPass !== confirmPass) { Swal.fire('Error', 'รหัสผ่านใหม่ไม่ตรงกัน', 'warning'); return; }

      this.innerText = 'Updating...'; this.disabled = true;

      google.script.run.withSuccessHandler(res => {
        this.innerText = 'Update Password'; this.disabled = false;
        if (res.success) {
          Swal.fire('Success', 'เปลี่ยนรหัสผ่านเรียบร้อย!', 'success');
          document.querySelectorAll('input').forEach(i => i.value = '');
        } else {
          Swal.fire('Error', res.message, 'error');
        }
      }).changeOwnPassword(token, oldPass, newPass);
    });
  </script>
</body>
</html>