<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
     body { background-color: #f4f6f8; font-family: 'Segoe UI', Roboto, sans-serif; }
     .module-container { max-width: 1200px; margin: 0 auto; padding: 20px; padding-bottom:100px; }
     
     /* Search Box Style */
     .search-box-card {
        padding: 20px; 
        background: white; 
        border-radius: 8px; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        display: flex;
        align-items: center;
        gap: 10px;
     }
     
     /* File List Style */
     .file-item { display: flex; justify-content: space-between; align-items: center; background: #eee; padding: 8px 12px; margin-bottom: 5px; border-radius: 4px; }
     .file-item a { text-decoration: none; color: #0277bd; font-weight: 500; }
     .delete-file { color: red; cursor: pointer; }
     
     #listView, #formView { display: none; }
  </style>
</head>
<body>

<div class="module-container">

  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
     <div>
        <h4 style="margin:0; font-weight:800; color:#37474f;">Item Master (Rev.08)</h4>
        <span class="grey-text">Inventory Data Management</span>
     </div>
     <div style="display:flex; gap:10px;">
       <button class="btn blue darken-3 waves-effect" onclick="openSpreadsheet()">
         <i class="material-icons left">table_view</i> Link to Data
       </button>
       
       <button class="btn orange darken-2 waves-effect" onclick="refreshCost()">
         <i class="material-icons left">sync</i> Refresh Cost
       </button>
       
       <button class="btn green darken-1 waves-effect" onclick="openCreate()">
         <i class="material-icons left">add</i> New Item
       </button>
     </div>
  </div>

  <div class="center-align" style="margin-bottom: 20px;">
     <button id="btnToggleList" class="btn-flat border" onclick="toggleListView()">Toggle List View</button>
  </div>

  <div id="listView">
     
     <div class="search-box-card">
        <div class="input-field" style="flex-grow:1; margin:0;">
             <i class="material-icons prefix">search</i>
             <input id="search-input" type="text" placeholder="Keyword: Name, Supplier, Source, Status, Allergen (e.g. 'RB*', 'Active', 'Produce')">
        </div>
        <button class="btn blue lighten-1 waves-effect" onclick="filterTable()">
           Search
        </button>
     </div>

     <div class="card" style="padding:20px; margin-top:10px;">
       <div style="overflow-x:auto;">
         <table class="striped centered">
           <thead>
             <tr>
               <th>Code</th><th>Name</th><th>Allergen</th><th>Source</th><th>Supplier</th><th>Status</th><th>Files</th><th>Action</th>
             </tr>
           </thead>
           <tbody id="item-tbody"></tbody>
         </table>
       </div>
       <div id="result-count" class="right-align grey-text" style="margin-top:10px; font-size:0.8rem;"></div>
     </div>
  </div>

  <div id="formView" class="card" style="padding:0; overflow:hidden;">
    <div style="padding: 20px; background: #eceff1; display:flex; justify-content:space-between;">
        <h5 id="formHeader" style="margin:0;">Create New Item</h5>
        <button class="btn-flat red-text" onclick="closeForm()">Cancel</button>
    </div>

    <div style="padding: 30px;">
        <input type="hidden" id="edit-id">
        <input type="hidden" id="existing-files-json"> 

        <div class="row">
            <div class="col s12 m4">
                <label>Item Code</label>
                <div style="display:flex;">
                   <input id="i-code" type="text" style="text-transform:uppercase;">
                   <button class="btn-small indigo" onclick="manualCheckCode()"><i class="material-icons">search</i></button>
                </div>
            </div>
            <div class="col s12 m8">
                <label>Item Name</label>
                <input id="i-name" type="text">
            </div>
        </div>

        <div class="row" style="background:#f9fbe7; padding:15px; border-radius:8px;">
            <div class="col s12"><h6 class="blue-text">Properties</h6></div>
            <div class="col s12 m4">
                <label>Category</label>
                <select id="i-cat" class="browser-default">
                   <option value="" disabled selected>Select</option>
                   <option value="Raw Material">Raw Material</option>
                   <option value="Packaging">Packaging</option>
                   <option value="Finished Good">Finished Good</option>
                   <option value="WIP">WIP</option>
                </select>
            </div>
            <div class="col s12 m4">
                <label>Allergen</label>
                <select id="i-allergen" class="browser-default">
                   <option value="Non-Allergen">Non-Allergen</option>
                   <option value="Allergen">Allergen</option>
                </select>
            </div>
            <div class="col s12 m4">
                <label>Status</label>
                <select id="i-status" class="browser-default">
                   <option value="Active">Active</option>
                   <option value="Inactive">Inactive</option>
                </select>
            </div>
        </div>

        <div class="row" style="margin-top:15px;">
            <div class="col s12 m6">
                <label>Source</label>
                <select id="i-source" class="browser-default" onchange="toggleSupplierUI()">
                    <option value="Purchase">Purchase</option>
                    <option value="Produce">Produce</option>
                    <option value="Customer">Customer</option> 
                </select>
            </div>
            <div class="col s12 m6">
                <label>Supplier Name</label>
                <input id="i-supplier" type="text">
            </div>
        </div>

        <div class="row" style="background:#e3f2fd; padding:15px; border-radius:8px; margin-top:15px;">
             <div class="col s12 m4">
                 <label>Temp (°C)</label>
                 <input id="i-temp" type="text">
             </div>
             <div class="col s12 m4">
                 <label>Humidity (%RH)</label>
                 <input id="i-rh" type="text">
             </div>
             <div class="col s12 m4">
                 <label>Files (PDF)</label>
                 <input type="file" id="i-files" multiple accept="application/pdf">
             </div>
             <div class="col s12" id="existing-files-container" style="margin-top:10px;"></div>
        </div>

        <div class="row" style="margin-top:15px;">
           <div class="col s12 m4"><label>UOM</label><select id="i-uom" class="browser-default"><option value="PCS">PCS</option><option value="KGS">KGS</option><option value="ROL">ROL</option></select></div>
           <div class="col s12 m4"><label>Cost</label><input id="i-cost" type="number" step="0.01"></div>
           <div class="col s12 m4"><label>Safety Stock</label><input id="i-safety" type="number"></div>
        </div>

        <div class="divider" style="margin:20px 0;"></div>
        <button id="btnSave" class="btn-large green w-100">Save Item</button>
    </div>
  </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  let allItems = [];
  let currentExistingFiles = [];

  document.addEventListener('DOMContentLoaded', () => { 
      M.AutoInit(); 
      loadTable();
      
      // Allow Enter key to search
      document.getElementById('search-input').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') filterTable();
      });
  });

  // --- Load Data ---
  function loadTable() {
     const tbody = document.getElementById('item-tbody');
     tbody.innerHTML = '<tr><td colspan="8">Loading data...</td></tr>';
     
     google.script.run.withSuccessHandler(items => {
        allItems = items; 
        renderTable(items);
        document.getElementById('listView').style.display = 'block';
     }).api_getAllItems();
  }

  function renderTable(items) {
     const tbody = document.getElementById('item-tbody');
     tbody.innerHTML = '';
     document.getElementById('result-count').innerText = `Total: ${items.length} items`;

     if(items.length === 0) { tbody.innerHTML = '<tr><td colspan="8">No Data Found</td></tr>'; return; }

     items.forEach(item => {
        const tr = document.createElement('tr');
        tr.dataset.json = JSON.stringify(item);
        
        const fileCount = item.files && item.files[0] !== "" ? item.files.length : 0;
        const fileBadge = fileCount > 0 ? `<span class="new badge blue" data-badge-caption="">${fileCount}</span>` : '-';
        
        // Status Color
        let statusStyle = item.status === 'Active' ? 'color:green; font-weight:bold;' : 'color:red;';

        tr.innerHTML = `
          <td><b>${item.code}</b></td>
          <td class="left-align">${item.name}</td>
          <td>${item.allergen}</td>
          <td>${item.source}</td>
          <td>${item.supplier || '-'}</td>
          <td style="${statusStyle}">${item.status}</td>
          <td>${fileBadge}</td>
          <td><button class="btn-small btn-flat" onclick="editItem(this)"><i class="material-icons">edit</i></button></td>
        `;
        tbody.appendChild(tr);
     });
  }

  // --- Search Logic (Updated Rev.08) ---
  function filterTable() {
      const input = document.getElementById('search-input').value.trim().toUpperCase();
      
      let filtered = [];
      
      // Case 1: Wildcard Search (e.g., RB*) - ยังคงรองรับ
      if (input.endsWith('*') && input.length > 1) {
          const prefix = input.slice(0, -1);
          filtered = allItems.filter(item => item.code.toUpperCase().startsWith(prefix));
      } 
      // Case 2: Multi-field Keyword Search (Partial Match)
      else {
          filtered = allItems.filter(item => {
              // รวมข้อมูลทุก Field ที่ต้องการค้นหา
              const searchableText = `
                  ${item.code} 
                  ${item.name} 
                  ${item.source} 
                  ${item.supplier || ''} 
                  ${item.status} 
                  ${item.allergen}
              `.toUpperCase();
              
              // เช็คว่ามีคำค้นหาอยู่ใน Text รวมหรือไม่
              return searchableText.includes(input);
          });
      }
      
      renderTable(filtered);
  }

  // --- Actions ---
  function openSpreadsheet() {
      google.script.run.withSuccessHandler(res => {
          if(res.success) {
              window.open(res.url, '_blank');
          } else {
              M.toast({html: 'Error getting URL'});
          }
      }).api_getSheetURL();
  }

  function refreshCost() {
      Swal.fire({title:'Syncing Cost', text:'Calculating from Stock...', didOpen:()=>Swal.showLoading()});
      google.script.run.withSuccessHandler(res => {
         Swal.close();
         Swal.fire(res.success?'Done':'Error', res.message, res.success?'success':'error');
         if(res.success) loadTable(); // Reload data to show new costs
      }).api_recalcAverageCost();
  }

  // --- Edit & Save (Logic เดิม) ---
  function openCreate() {
      document.getElementById('edit-id').value = '';
      document.querySelectorAll('input').forEach(i => i.value = '');
      document.getElementById('existing-files-container').innerHTML = '';
      currentExistingFiles = [];
      document.getElementById('formView').style.display = 'block';
      document.getElementById('listView').style.display = 'none';
  }
  
  function closeForm() {
      document.getElementById('formView').style.display = 'none';
      document.getElementById('listView').style.display = 'block';
  }

  window.editItem = function(btn) {
      const item = JSON.parse(btn.closest('tr').dataset.json);
      // Map data to fields... (ย่อ Code ส่วนนี้เพราะเหมือนเดิม)
      document.getElementById('edit-id').value = item.id;
      document.getElementById('i-code').value = item.code;
      document.getElementById('i-name').value = item.name;
      document.getElementById('i-cat').value = item.category;
      document.getElementById('i-status').value = item.status;
      document.getElementById('i-source').value = item.source;
      document.getElementById('i-supplier').value = item.supplier || '';
      document.getElementById('i-uom').value = item.uom;
      document.getElementById('i-cost').value = item.cost;
      document.getElementById('i-safety').value = item.safetyStock;
      document.getElementById('i-allergen').value = item.allergen || 'Non-Allergen';
      document.getElementById('i-temp').value = item.storageTemp || '';
      document.getElementById('i-rh').value = item.storageRH || '';
      
      // Files Logic
      currentExistingFiles = (item.files && item.files[0] !== "") ? item.files : [];
      renderExistingFiles();

      document.getElementById('formView').style.display = 'block';
      document.getElementById('listView').style.display = 'none';
      M.updateTextFields();
      toggleSupplierUI();
  };

  function renderExistingFiles() {
      const container = document.getElementById('existing-files-container');
      container.innerHTML = '';
      if(currentExistingFiles.length === 0) return;
      let html = '<label>Attached Files:</label>';
      currentExistingFiles.forEach((fString, index) => {
          const parts = fString.split('|');
          const fUrl = 'https://drive.google.com/uc?id=' + parts[0] + '&export=view';
          html += `
            <div class="file-item">
               <a href="${fUrl}" target="_blank"><i class="material-icons tiny">picture_as_pdf</i> ${parts[1]}</a>
               <span class="delete-file" onclick="removeFile(${index})"><i class="material-icons tiny">delete</i></span>
            </div>`;
      });
      container.innerHTML = html;
  }
  function removeFile(index) {
      currentExistingFiles.splice(index, 1);
      renderExistingFiles();
  }
  
  // File to Base64 & Save
  const toBase64 = file => new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result);
      reader.onerror = error => reject(error);
  });

  document.getElementById('btnSave').addEventListener('click', async function() {
      const btn = this; btn.disabled = true; btn.innerText = 'Processing...';
      
      // Upload Logic
      const fileInput = document.getElementById('i-files');
      const newFilesToUpload = [];
      if (fileInput.files.length > 0) {
          for (let i = 0; i < fileInput.files.length; i++) {
              const base64 = await toBase64(fileInput.files[i]);
              newFilesToUpload.push({
                  name: fileInput.files[i].name,
                  type: fileInput.files[i].type,
                  data: base64.split(',')[1]
              });
          }
      }

      const itemData = {
          id: document.getElementById('edit-id').value,
          code: document.getElementById('i-code').value,
          name: document.getElementById('i-name').value,
          category: document.getElementById('i-cat').value,
          status: document.getElementById('i-status').value,
          source: document.getElementById('i-source').value,
          supplier: document.getElementById('i-supplier').value,
          uom: document.getElementById('i-uom').value,
          cost: document.getElementById('i-cost').value,
          safetyStock: document.getElementById('i-safety').value,
          allergen: document.getElementById('i-allergen').value,
          storageTemp: document.getElementById('i-temp').value,
          storageRH: document.getElementById('i-rh').value,
          existingFiles: currentExistingFiles,
          newFiles: newFilesToUpload
      };

      google.script.run.withSuccessHandler(res => {
          btn.disabled = false; btn.innerText = 'Save Item';
          if(res.success) { Swal.fire('Saved', '', 'success'); closeForm(); loadTable(); }
          else { Swal.fire('Error', res.message, 'error'); }
      }).api_saveItem(itemData);
  });

  function toggleListView() {
      const el = document.getElementById('listView');
      el.style.display = el.style.display === 'none' ? 'block' : 'none';
  }
  function toggleSupplierUI() {
      const source = document.getElementById('i-source').value;
      document.getElementById('i-supplier').disabled = (source === 'Produce');
  }
  function manualCheckCode() { /* ...Logic check code... */ }

</script>

</body>
</html>
