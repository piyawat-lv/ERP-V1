<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <style>
    body { background-color: #f4f6f8; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
    .module-container { max-width: 1200px; margin: 0 auto; padding: 20px; padding-bottom: 80px; }
    
    /* Dashboard Cards */
    .dash-row { display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
    .dash-card { 
       flex: 1; min-width: 280px; background: white; 
       padding: 24px; border-radius: 12px; 
       box-shadow: 0 2px 10px rgba(0,0,0,0.03);
       border-left: 5px solid #5c6bc0;
       transition: transform 0.2s;
    }
    .dash-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
    .dash-title { color: #90a4ae; font-size: 0.85rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
    .dash-value { font-size: 2.5rem; font-weight: 700; color: #263238; margin: 15px 0 5px 0; }
    .dash-sub { font-size: 0.85rem; color: #b0bec5; }
    
    /* Progress Bars */
    .stat-row { display: flex; justify-content: space-between; margin-top: 12px; font-size: 0.85rem; color:#546e7a; }
    .progress-bg { background: #eceff1; height: 6px; border-radius: 3px; overflow: hidden; margin-top: 6px; }
    .progress-fill { height: 100%; background: #5c6bc0; border-radius: 3px; }

    /* Buttons */
    .btn-main { background: #81d4fa; background: linear-gradient(45deg, #4dd0e1, #80cbc4); border-radius: 50px; font-weight: 700; color: white; border:none; box-shadow: 0 4px 12px rgba(77, 208, 225, 0.4); }
    .btn-main:hover { background: linear-gradient(45deg, #26c6da, #4db6ac); box-shadow: 0 6px 16px rgba(77, 208, 225, 0.5); }
    
    .btn-refresh { background: #ffcc80; color:#e65100; border-radius: 50px; font-weight: 700; box-shadow: none; }
    .btn-refresh:hover { background: #ffb74d; }

    .btn-outline { background: transparent; border: 2px solid #cfd8dc; color: #78909c; border-radius: 50px; font-weight: 600; box-shadow: none; }
    .btn-outline:hover { background: #eceff1; color: #546e7a; }

    /* Views */
    #listView, #formView { display: none; animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Status Badges */
    .status-active { color: #2e7d32; font-weight: 700; background: #e8f5e9; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; }
    .status-inactive { color: #c62828; font-weight: 700; background: #ffebee; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; }
    
    /* Table */
    table.striped > tbody > tr:nth-child(odd) { background-color: #fafafa; }
    th { color: #78909c; font-weight: 600; font-size: 0.9rem; }
    td { color: #37474f; font-size: 0.95rem; }

    /* Input Fields */
    input:not([type]), input[type=text]:not(.browser-default), input[type=number]:not(.browser-default) {
        border-bottom: 1px solid #cfd8dc;
        height: 2.5rem;
    }
    input:focus:not([type]), input[type=text]:focus:not(.browser-default), input[type=number]:focus:not(.browser-default) {
        border-bottom: 1px solid #26a69a; box-shadow: 0 1px 0 0 #26a69a;
    }
  </style>
</head>
<body>

<div class="module-container">

  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
    <div>
       <h4 style="margin:0; font-weight:800; color:#37474f; letter-spacing:-0.5px;">Item Master</h4>
       <span class="grey-text text-darken-1">Manage Products & Inventory Data</span>
    </div>
    <div style="display:flex; gap:10px;">
       <button class="btn btn-refresh waves-effect" onclick="refreshCost()">
         <i class="material-icons left">sync</i> Refresh Cost
       </button>
       <button class="btn btn-main waves-effect waves-light" onclick="openCreate()">
         <i class="material-icons left">add</i> New Item
       </button>
    </div>
  </div>

  <div class="dash-row">
    <div class="dash-card" style="border-color: #5c6bc0;">
      <div class="dash-title">Total Items</div>
      <div class="dash-value" id="d-total">-</div>
      <div class="dash-sub">SKUs registered</div>
    </div>

    <div class="dash-card" style="border-color: #66bb6a;">
      <div class="dash-title">Status Breakdown</div>
      <div id="d-status-list" style="margin-top:15px;">Loading...</div>
    </div>

    <div class="dash-card" style="border-color: #ffa726;">
      <div class="dash-title">Categories</div>
      <div id="d-cat-list" style="margin-top:15px;">Loading...</div>
    </div>
  </div>

  <div class="center-align" style="margin-bottom: 30px;">
     <button id="btnToggleList" class="btn-large btn-outline waves-effect" onclick="toggleListView()">
       <i class="material-icons left">list</i> Show All Items List
     </button>
  </div>

  <div id="listView" class="card" style="border-radius:12px; padding:20px; border:none; box-shadow: 0 4px 20px rgba(0,0,0,0.05);">
     <div class="input-field" style="max-width:300px; margin-bottom:20px;">
        <i class="material-icons prefix grey-text">search</i>
        <input id="search-input" type="text" onkeyup="filterTable()" placeholder="Search Code, Name, Supplier...">
     </div>
     <div style="overflow-x:auto;">
       <table class="highlight centered">
         <thead>
           <tr>
             <th>Code</th>
             <th class="left-align">Name</th>
             <th>Category</th>
             <th>Source</th>
             <th>Supplier</th> <th>UOM</th>
             <th>Cost</th>
             <th>Status</th>
             <th>Action</th>
           </tr>
         </thead>
         <tbody id="item-tbody"></tbody>
       </table>
     </div>
  </div>

  <div id="formView" class="card" style="border-radius:12px; padding:0; border:none; box-shadow: 0 15px 35px rgba(0,0,0,0.1); overflow:hidden;">
    
    <div style="background: linear-gradient(to right, #eceff1, #ffffff); padding: 20px 30px; border-bottom: 1px solid #e0e0e0; display:flex; justify-content:space-between; align-items:center;">
        <div>
            <h5 id="formHeader" style="font-weight:700; color:#37474f; margin:0;">Create New Item</h5>
            <span style="font-size:0.85rem; color:#78909c;">Fill in the details to register a new product SKU.</span>
        </div>
        <button class="btn-flat red-text waves-effect" style="font-weight:600;" onclick="closeForm()">
            <i class="material-icons left">close</i>Cancel
        </button>
    </div>

    <div style="padding: 30px;">
        <input type="hidden" id="edit-id">
        
        <div class="row">
            <div class="col s12 m4">
                <label style="font-size:0.85rem; font-weight:bold; color:#5c6bc0;">Item Code *</label>
                <div style="display: flex; align-items: flex-start; margin-top: 5px;">
                    <div class="input-field" style="flex-grow:1; margin:0;">
                        <input id="i-code" type="text" style="text-transform:uppercase; font-weight:700; height: 38px; border: 1px solid #cfd8dc; border-radius: 4px; padding: 0 10px; background:#fafafa;" placeholder="Ex. RM-001">
                    </div>
                    <button class="btn waves-effect waves-light indigo lighten-1 tooltipped" 
                            data-position="top" data-tooltip="Check Duplicate"
                            style="margin-left: 8px; height: 40px; border-radius: 4px; padding: 0 12px; box-shadow:none;"
                            onclick="manualCheckCode()">
                        <i class="material-icons">search</i>
                    </button>
                </div>
                <span id="code-helper-text" class="helper-text" style="font-size:0.75rem; margin-top:5px; display:block; min-height:18px;"></span>
            </div>

            <div class="col s12 m8">
                <label style="font-size:0.85rem; color:#546e7a;">Item Name / Trade Name *</label>
                <div class="input-field" style="margin-top: 5px;">
                    <input id="i-name" type="text" style="height: 38px; border-bottom: 1px solid #cfd8dc; font-size:1rem;">
                </div>
            </div>
        </div>

        <div class="row" style="background: #f8fbfd; padding: 25px; border-radius: 8px; border: 1px solid #e1f5fe; margin-top:15px;">
            <div class="col s12" style="margin-bottom:20px;">
                <span style="font-weight:700; color:#0277bd; font-size:0.85rem; letter-spacing:0.5px; text-transform:uppercase;">
                   <i class="material-icons tiny left">layers</i> Classification & Source
                </span>
            </div>
            
            <div class="col s12 m6">
                <label>Category</label>
                <select id="i-cat" class="browser-default" style="margin-top:5px; border:1px solid #cfd8dc; border-radius:4px; height:38px; background:white;">
                    <option value="" disabled selected>Select Category</option>
                    <option value="Raw Material">Raw Material</option>
                    <option value="Packaging">Packaging</option>
                    <option value="Finished Good">Finished Good</option>
                    <option value="Manufacturing">Manufacturing</option>
                    <option value="WIP">WIP</option>
                </select>
            </div>

            <div class="col s12 m6">
                 <label>Status</label>
                 <select id="i-status" class="browser-default" style="margin-top:5px; border:1px solid #cfd8dc; border-radius:4px; height:38px; background:white;">
                    <option value="Active">Active (Allow Usage)</option>
                    <option value="Inactive">Inactive (Block)</option>
                 </select>
            </div>

            <div class="col s12 m6" style="margin-top: 20px;">
                <label>Source</label>
                <select id="i-source" class="browser-default" onchange="toggleSupplierUI()" style="margin-top:5px; border:1px solid #cfd8dc; border-radius:4px; height:38px; background:white;">
                    <option value="" disabled selected>Select Source</option>
                    <option value="Purchase">Purchase (ซื้อมา)</option>
                    <option value="Produce">Produce (ผลิตเอง)</option>
                    <option value="Customer">Customer (ลูกค้า)</option> 
                </select>
            </div>

            <div class="col s12 m6" style="margin-top: 20px;">
                <label>Supplier / Vendor / Customer Name</label>
                <div class="input-field" style="margin-top: 5px;">
                    <input id="i-supplier" type="text" style="height: 38px; border: 1px solid #cfd8dc; border-radius: 4px; padding: 0 10px; background: white;" placeholder="Specify Name">
                </div>
            </div>
        </div>

        <div class="row" style="margin-top: 25px;">
           <div class="col s12 m4">
              <label>Unit (UOM)</label>
              <select id="i-uom" class="browser-default" style="margin-top:5px; border:1px solid #cfd8dc; border-radius:4px; height:38px;">
                 <option value="" disabled selected>Select UOM</option>
                 <option value="PCS">PCS</option>
                 <option value="KGS">KGS</option>
                 <option value="ROL">ROL</option>
                 <option value="MIL">MIL</option>
                 <option value="LTR">LTR</option>
                 <option value="SET">SET</option>
              </select>
           </div>
           
           <div class="col s12 m4">
              <label>Cost Per Unit (THB)</label>
              <div class="input-field" style="margin-top: 5px;">
                  <i class="material-icons prefix tiny grey-text" style="top:10px;">attach_money</i>
                  <input id="i-cost" type="number" step="0.01" style="height: 38px; margin-left:30px; width:calc(100% - 30px); border-bottom:1px solid #cfd8dc;">
              </div>
           </div>
           
           <div class="col s12 m4">
              <label>Safety Stock</label>
              <div class="input-field" style="margin-top: 5px;">
                  <i class="material-icons prefix tiny grey-text" style="top:10px;">warning</i>
                  <input id="i-safety" type="number" style="height: 38px; margin-left:30px; width:calc(100% - 30px); border-bottom:1px solid #cfd8dc;">
              </div>
           </div>
        </div>

        <div class="divider" style="margin: 30px 0;"></div>

        <div class="right-align">
           <button id="btnSave" class="btn-large waves-effect waves-light orange darken-2 z-depth-2" style="border-radius:50px; min-width:200px; font-weight:bold;">
              <i class="material-icons left">save</i> Save Item
           </button>
        </div>
    </div>
  </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  // --- Initialization ---
  document.addEventListener('DOMContentLoaded', () => {
     M.AutoInit();
     loadDashboard(); // Load Data
  });

  // --- 1. DASHBOARD LOGIC ---
  function loadDashboard() {
     google.script.run.withSuccessHandler(stats => {
        // Total
        document.getElementById('d-total').innerText = stats.total;
        
        // Status Bars
        const activePct = Math.round((stats.status.Active / stats.total) * 100) || 0;
        const inactivePct = Math.round((stats.status.Inactive / stats.total) * 100) || 0;
        
        document.getElementById('d-status-list').innerHTML = `
           <div class="stat-row"><span>Active (${stats.status.Active})</span><span>${activePct}%</span></div>
           <div class="progress-bg"><div class="progress-fill green lighten-1" style="width:${activePct}%"></div></div>
           
           <div class="stat-row" style="margin-top:10px;"><span>Inactive (${stats.status.Inactive})</span><span>${inactivePct}%</span></div>
           <div class="progress-bg"><div class="progress-fill red lighten-2" style="width:${inactivePct}%"></div></div>
        `;

        // Categories
        let catHtml = '';
        const colors = ['orange', 'blue', 'teal', 'purple', 'cyan'];
        let cIdx = 0;
        for (const [cat, count] of Object.entries(stats.categories)) {
           const pct = Math.round((count / stats.total) * 100);
           const color = colors[cIdx % colors.length];
           catHtml += `
             <div class="stat-row"><span>${cat}</span><span>${count}</span></div>
             <div class="progress-bg"><div class="progress-fill ${color} lighten-1" style="width:${pct}%"></div></div>
           `;
           cIdx++;
        }
        document.getElementById('d-cat-list').innerHTML = catHtml || '<span class="grey-text">No data</span>';

     }).api_getItemDashboardStats();
  }

  // --- 2. LIST VIEW & TABLE ---
  let isListLoaded = false;
  
  function toggleListView() {
     const listDiv = document.getElementById('listView');
     const btn = document.getElementById('btnToggleList');
     
     if (listDiv.style.display === 'none' || listDiv.style.display === '') {
        listDiv.style.display = 'block';
        btn.innerHTML = '<i class="material-icons left">expand_less</i> Hide List';
        if (!isListLoaded) { loadTable(); }
     } else {
        listDiv.style.display = 'none';
        btn.innerHTML = '<i class="material-icons left">list</i> Show All Items List';
     }
  }

  function loadTable() {
     const tbody = document.getElementById('item-tbody');
     tbody.innerHTML = '<tr><td colspan="9" class="center-align grey-text">Loading data...</td></tr>';
     
     google.script.run.withSuccessHandler(items => {
        tbody.innerHTML = '';
        isListLoaded = true;
        if(items.length === 0) { tbody.innerHTML = '<tr><td colspan="9">No items found</td></tr>'; return; }

        items.forEach(item => {
           const tr = document.createElement('tr');
           tr.dataset.json = JSON.stringify(item); // เก็บ Data ไว้ใน tr
           
           // Status Badge
           const statusHtml = item.status === 'Active' 
             ? '<span class="status-active">Active</span>' 
             : '<span class="status-inactive">Inactive</span>';
           
           tr.innerHTML = `
             <td style="font-weight:700;">${item.code}</td>
             <td class="left-align">${item.name}</td>
             <td>${item.category}</td>
             <td><span class="new badge grey lighten-1" data-badge-caption="">${item.source || '-'}</span></td>
             <td>${item.supplier || '-'}</td>
             <td>${item.uom}</td>
             <td>${Number(item.cost).toFixed(2)}</td>
             <td>${statusHtml}</td>
             <td>
                <button class="btn-small btn-flat waves-effect" onclick="editItem(this)">
                  <i class="material-icons blue-text">edit</i>
                </button>
             </td>
           `;
           tbody.appendChild(tr);
        });
     }).api_getAllItems();
  }
  
  // Filter Table
  function filterTable() {
    const input = document.getElementById("search-input");
    const filter = input.value.toUpperCase();
    const table = document.getElementById("item-tbody");
    const tr = table.getElementsByTagName("tr");
    for (let i = 0; i < tr.length; i++) {
        const textData = tr[i].innerText.toUpperCase();
        if (textData.indexOf(filter) > -1) {
            tr[i].style.display = "";
        } else {
            tr[i].style.display = "none";
        }
    }
  }

  // --- 3. CREATE & EDIT LOGIC ---

  function openCreate() {
     resetForm(); // เคลียร์ฟอร์ม
     document.getElementById('formView').style.display = 'block';
     document.getElementById('listView').style.display = 'none'; 
     window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
  }
  
  function closeForm() {
     document.getElementById('formView').style.display = 'none';
     window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  window.editItem = function(btn) {
     const item = JSON.parse(btn.closest('tr').dataset.json);
     
     document.getElementById('edit-id').value = item.id;
     document.getElementById('i-code').value = item.code;
     document.getElementById('i-name').value = item.name;
     document.getElementById('i-cost').value = item.cost;
     document.getElementById('i-safety').value = item.safetyStock;

     // Select Inputs
     setSelect('i-cat', item.category);
     setSelect('i-status', item.status);
     setSelect('i-uom', item.uom);
     
     // Source & Supplier Logic
     setSelect('i-source', item.source);
     document.getElementById('i-supplier').value = item.supplier || '';
     toggleSupplierUI(); // Check disable logic

     // UI Updates
     document.getElementById('formHeader').innerText = 'Edit Item: ' + item.code;
     document.getElementById('btnSave').innerHTML = '<i class="material-icons left">save</i> Update Item';
     
     document.getElementById('formView').style.display = 'block';
     M.updateTextFields();
     window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
  };

  function resetForm() {
     document.getElementById('edit-id').value = '';
     document.querySelectorAll('#formView input').forEach(i => i.value = '');
     
     setSelect('i-status', 'Active');
     setSelect('i-source', 'Purchase'); 
     
     // Reset Supplier UI
     const supInput = document.getElementById('i-supplier');
     supInput.disabled = false;
     supInput.style.backgroundColor = "white";

     document.getElementById('formHeader').innerText = 'Create New Item';
     document.getElementById('btnSave').innerHTML = '<i class="material-icons left">save</i> Save Item';
     document.getElementById('code-helper-text').innerText = '';
     
     M.updateTextFields();
  }

  // --- 4. SUPPLIER LOGIC ---
  function toggleSupplierUI() {
      const source = document.getElementById('i-source').value;
      const supplierInput = document.getElementById('i-supplier');
      
      if (source === 'Produce') {
          supplierInput.value = 'N/A (In-House)';
          supplierInput.disabled = true;
          supplierInput.style.backgroundColor = "#f5f5f5";
      } else {
          supplierInput.disabled = false;
          supplierInput.style.backgroundColor = "white";
          if(supplierInput.value === 'N/A (In-House)') supplierInput.value = '';
      }
      M.updateTextFields();
  }

  // --- 5. SAVE DATA ---
  document.getElementById('btnSave').addEventListener('click', function() {
     const id = document.getElementById('edit-id').value;
     
     const itemData = {
         id: id,
         code: document.getElementById('i-code').value.trim(),
         name: document.getElementById('i-name').value,
         category: document.getElementById('i-cat').value,
         source: document.getElementById('i-source').value,
         supplier: document.getElementById('i-supplier').value, // Send Supplier
         uom: document.getElementById('i-uom').value,
         cost: document.getElementById('i-cost').value,
         safetyStock: document.getElementById('i-safety').value,
         status: document.getElementById('i-status').value
     };

     if(!itemData.code || !itemData.name) { 
         Swal.fire('Required', 'Please fill Item Code and Name.', 'warning'); 
         return; 
     }
     
     const btn = this; 
     btn.disabled = true; 
     btn.innerHTML = '<i class="material-icons left">hourglass_empty</i> Saving...';
     
     google.script.run.withSuccessHandler(res => {
        btn.disabled = false; 
        btn.innerHTML = id ? '<i class="material-icons left">save</i> Update Item' : '<i class="material-icons left">save</i> Save Item';
        
        if(res.success) {
           Swal.fire('Success', res.message, 'success');
           if(!id) resetForm(); else closeForm();
           loadDashboard(); // Update stats
           if(isListLoaded) loadTable(); // Update list if open
        } else if(res.isDuplicate) {
             Swal.fire({
               title: 'Duplicate Code', 
               html: `${res.message}<br><small>${res.detail}</small>`, 
               icon: 'warning',
               showCancelButton: true, 
               confirmButtonText: `Use ${res.nextCode}`
            }).then(r => { 
               if(r.isConfirmed) { 
                   document.getElementById('i-code').value = res.nextCode; 
                   M.updateTextFields(); 
               } 
            });
        } else {
           Swal.fire('Error', res.message, 'error');
        }
     }).api_saveItem(itemData);
  });

  // --- Helpers ---
  function setSelect(id, val) {
     const el = document.getElementById(id);
     if(el) {
         el.value = val;
         // Re-init materialize select if needed (browser-default doesn't need it but good practice if mixed)
     }
  }

  function manualCheckCode() {
    const code = document.getElementById('i-code').value.trim();
    const helper = document.getElementById('code-helper-text');
    if(!code) { M.toast({html: 'Enter code first'}); return; }
    
    helper.innerText = "Checking..."; helper.style.color = "grey";
    google.script.run.withSuccessHandler(res => {
       if (res.status === 'AVAILABLE') {
          helper.innerText = "✓ " + res.message; helper.style.color = "green";
       } else {
          helper.innerText = "✗ " + res.message; helper.style.color = "red";
          if(res.nextCode) M.toast({html: `Suggest: ${res.nextCode}`});
       }
    }).api_checkItemCode(code);
  }
  
  function refreshCost() {
     Swal.fire({title:'Syncing Cost', text:'Calculating Weighted Average...', didOpen:()=>Swal.showLoading()});
     google.script.run.withSuccessHandler(res => {
        Swal.close();
        Swal.fire(res.success?'Done':'Error', res.message, res.success?'success':'error');
     }).api_recalcAverageCost();
  }
</script>

</body>
</html>