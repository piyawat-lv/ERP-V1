<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    body { background-color: #f4f6f8; font-family: 'Segoe UI', Roboto, sans-serif; }
    .module-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .section-card { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    
    /* Table Inputs */
    .tbl-input { border: 1px solid #e0e0e0 !important; height: 2rem !important; padding: 0 5px !important; border-radius: 2px !important; font-size: 0.9rem !important; margin: 0 !important; }
    .tbl-input:focus { border: 1px solid #2196f3 !important; box-shadow: none !important; }
    .readonly-input { background-color: #f5f5f5; color: #616161; }
    
    th { font-size: 0.85rem; color: #546e7a; background: #eceff1; }
    td { padding: 5px 2px !important; }

    #listView, #formView { display: none; }
  </style>
</head>
<body>

<div class="module-container">

  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
     <h5 style="margin:0; font-weight:800; color:#37474f;">BOM Management (Rev.02)</h5>
     <button class="btn btn-large blue darken-2" onclick="openCreate()"><i class="material-icons left">add</i> New BOM</button>
  </div>

  <div id="listView" class="section-card">
     <table class="striped centered">
       <thead>
         <tr>
           <th>BOM ID</th><th>Item Code</th><th>Item Name</th><th>Type</th><th>Batch Size</th><th>Rev</th><th>Status</th><th>Action</th>
         </tr>
       </thead>
       <tbody id="bom-list-tbody"></tbody>
     </table>
  </div>

  <div id="formView">
    
    <div class="section-card" style="border-top: 4px solid #1565c0;">
       <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
          <h6 style="font-weight:700; margin:0;">BOM Header</h6>
          <button class="btn-flat red-text" onclick="closeForm()">Cancel</button>
       </div>
       
       <input type="hidden" id="h-bom-id">
       <div class="row" style="margin-bottom:0;">
          <div class="col s12 m3">
             <label>Item Code (FG/WIP)</label>
             <input id="h-item-code" type="text" placeholder="Type Code..." onchange="lookupHeaderItem()">
          </div>
          <div class="col s12 m3">
             <label>Item Name (Auto)</label>
             <input id="h-item-name" type="text" readonly class="readonly-input">
          </div>
          <div class="col s12 m2">
             <label>Type</label>
             <select id="h-type" class="browser-default" style="height: 2.5rem; border:1px solid #cfd8dc;">
                 <option value="FG">FG</option>
                 <option value="WIP">WIP</option>
             </select>
          </div>
          <div class="col s12 m2">
             <label>Batch Size</label>
             <input id="h-size" type="number" placeholder="100">
          </div>
          <div class="col s12 m2">
             <label>UOM</label>
             <select id="h-uom" class="browser-default" style="height: 2.5rem; border:1px solid #cfd8dc;">
                 <option value="KGS">KGS</option>
                 <option value="PCS">PCS</option>
             </select>
          </div>
       </div>
    </div>

    <div class="section-card">
       <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <h6 style="font-weight:700; margin:0;">BOM Details</h6>
          <button class="btn-small green" onclick="addDetailRow()"><i class="material-icons left">add</i> Add Row</button>
       </div>
       
       <table class="centered">
          <thead>
             <tr>
                <th style="width:5%">Seq</th>
                <th style="width:15%">Work Description</th>
                <th style="width:10%">Item Code</th>
                <th style="width:15%">Item Name (Auto)</th>
                <th style="width:10%">Station Code</th>
                <th style="width:15%">Station Name (Auto)</th>
                <th style="width:8%">Qty/Time</th>
                <th style="width:7%">UOM</th>
                <th style="width:10%">Parameters</th>
                <th style="width:5%">Del</th>
             </tr>
          </thead>
          <tbody id="detail-tbody"></tbody>
       </table>
    </div>

    <button id="btnSave" class="btn-large blue darken-2 w-100" style="width:100%; margin-bottom:50px;">
        <i class="material-icons left">save</i> Save BOM
    </button>

  </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  // Global Data for VLOOKUP
  let masterItems = [];
  let masterStations = [];

  document.addEventListener('DOMContentLoaded', () => { 
      M.AutoInit(); 
      initData(); 
  });

  function initData() {
     google.script.run.withSuccessHandler(data => {
        masterItems = data.items;
        masterStations = data.stations;
        loadBOMList();
     }).api_getMasterDataForBOM();
  }

  // --- Header Logic ---
  function lookupHeaderItem() {
      const code = document.getElementById('h-item-code').value.trim().toUpperCase();
      const item = masterItems.find(i => i.code === code);
      if(item) {
          document.getElementById('h-item-name').value = item.name;
          document.getElementById('h-item-code').value = item.code; // Format Case
      } else {
          document.getElementById('h-item-name').value = '';
          M.toast({html: 'Item Code not found', classes: 'red'});
      }
  }

  // --- Detail Logic ---
  function addDetailRow(data = null) {
      const tbody = document.getElementById('detail-tbody');
      const tr = document.createElement('tr');

      const seq = data ? data.seq : '';
      const desc = data ? data.workDesc : '';
      const iCode = data ? data.itemCode : '';
      const iName = data ? data.itemName : '';
      const sCode = data ? data.stationCode : '';
      const sName = data ? data.stationName : '';
      const qty = data ? data.qty : '';
      const uom = data ? data.uom : '';
      const params = data ? data.params : '';

      tr.innerHTML = `
        <td><input type="text" class="tbl-input row-seq center-align" value="${seq}"></td>
        <td><input type="text" class="tbl-input row-desc" value="${desc}"></td>
        
        <td><input type="text" class="tbl-input row-icode" value="${iCode}" onchange="lookupRowItem(this)"></td>
        <td><input type="text" class="tbl-input readonly-input row-iname" value="${iName}" readonly></td>
        
        <td><input type="text" class="tbl-input row-scode" value="${sCode}" onchange="lookupRowStation(this)"></td>
        <td><input type="text" class="tbl-input readonly-input row-sname" value="${sName}" readonly></td>
        
        <td><input type="number" class="tbl-input row-qty center-align" value="${qty}"></td>
        <td><input type="text" class="tbl-input row-uom center-align" value="${uom}"></td>
        <td><input type="text" class="tbl-input row-params" value="${params}"></td>
        
        <td><i class="material-icons red-text tiny" style="cursor:pointer" onclick="this.closest('tr').remove()">close</i></td>
      `;
      tbody.appendChild(tr);
  }

  // VLOOKUP for Row Item
  function lookupRowItem(input) {
      const code = input.value.trim().toUpperCase();
      const tr = input.closest('tr');
      const item = masterItems.find(i => i.code === code);
      
      if(item) {
          input.value = item.code;
          tr.querySelector('.row-iname').value = item.name;
          // Auto fill UOM if empty
          if(!tr.querySelector('.row-uom').value) tr.querySelector('.row-uom').value = item.uom;
      } else {
          tr.querySelector('.row-iname').value = '';
          if(code) M.toast({html: 'Item not found', classes: 'red'});
      }
  }

  // VLOOKUP for Row Station
  function lookupRowStation(input) {
      const code = input.value.trim().toUpperCase();
      const tr = input.closest('tr');
      const station = masterStations.find(s => s.code === code);
      
      if(station) {
          input.value = station.code;
          tr.querySelector('.row-sname').value = station.name;
      } else {
          tr.querySelector('.row-sname').value = '';
          if(code) M.toast({html: 'Station not found', classes: 'red'});
      }
  }

  // --- CRUD Actions ---
  function openCreate() {
      document.getElementById('h-bom-id').value = '';
      document.getElementById('h-item-code').value = '';
      document.getElementById('h-item-name').value = '';
      document.getElementById('h-size').value = '';
      document.getElementById('detail-tbody').innerHTML = '';
      addDetailRow(); // Add 1 empty row
      
      toggleView('form');
  }

  function closeForm() { toggleView('list'); }

  function toggleView(view) {
      document.getElementById('listView').style.display = view === 'list' ? 'block' : 'none';
      document.getElementById('formView').style.display = view === 'form' ? 'block' : 'none';
  }

  function loadBOMList() {
      const tbody = document.getElementById('bom-list-tbody');
      tbody.innerHTML = '<tr><td colspan="8">Loading...</td></tr>';
      
      google.script.run.withSuccessHandler(list => {
          tbody.innerHTML = '';
          if(list.length === 0) { tbody.innerHTML = '<tr><td colspan="8">No Data</td></tr>'; return; }
          
          list.forEach(b => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td><b>${b.bomId}</b></td>
                <td>${b.itemCode}</td>
                <td class="left-align">${b.itemName}</td>
                <td>${b.type}</td>
                <td>${b.batchSize} ${b.batchUom}</td>
                <td>${b.revision}</td>
                <td>${b.status}</td>
                <td><button class="btn-small btn-flat" onclick="editBOM('${b.bomId}')"><i class="material-icons">edit</i></button></td>
              `;
              tbody.appendChild(tr);
          });
          toggleView('list');
      }).api_getBOMList();
  }

  window.editBOM = function(id) {
      google.script.run.withSuccessHandler(data => {
          if(!data) return;
          
          // Header
          document.getElementById('h-bom-id').value = data.header.bomId;
          document.getElementById('h-item-code').value = data.header.itemCode;
          document.getElementById('h-item-name').value = data.header.itemName;
          document.getElementById('h-type').value = data.header.type;
          document.getElementById('h-size').value = data.header.batchSize;
          document.getElementById('h-uom').value = data.header.batchUom;
          
          // Details
          const tbody = document.getElementById('detail-tbody');
          tbody.innerHTML = '';
          data.details.forEach(d => addDetailRow(d));
          
          toggleView('form');
      }).api_getBOMDetail(id);
  };

  // --- SAVE ---
  document.getElementById('btnSave').addEventListener('click', function() {
      const btn = this;
      
      // Header Data
      const header = {
          bomId: document.getElementById('h-bom-id').value,
          itemCode: document.getElementById('h-item-code').value.trim(),
          itemName: document.getElementById('h-item-name').value,
          type: document.getElementById('h-type').value,
          batchSize: document.getElementById('h-size').value,
          batchUom: document.getElementById('h-uom').value,
          status: 'Active'
      };

      if(!header.itemCode) { Swal.fire('Error', 'Please enter Item Code', 'error'); return; }

      // Details Data
      const details = [];
      document.querySelectorAll('#detail-tbody tr').forEach(tr => {
          const itemCode = tr.querySelector('.row-icode').value.trim();
          const stationCode = tr.querySelector('.row-scode').value.trim();
          
          // ต้องมีอย่างน้อย 1 อย่าง (Item หรือ Station)
          if(itemCode || stationCode) {
              details.push({
                  seq: tr.querySelector('.row-seq').value,
                  workDesc: tr.querySelector('.row-desc').value,
                  itemCode: itemCode,
                  itemName: tr.querySelector('.row-iname').value,
                  stationCode: stationCode,
                  stationName: tr.querySelector('.row-sname').value,
                  qty: tr.querySelector('.row-qty').value,
                  uom: tr.querySelector('.row-uom').value,
                  params: tr.querySelector('.row-params').value
              });
          }
      });

      btn.disabled = true; btn.innerText = 'Saving...';
      
      google.script.run.withSuccessHandler(res => {
          btn.disabled = false; btn.innerHTML = '<i class="material-icons left">save</i> Save BOM';
          if(res.success) {
              Swal.fire('Success', 'BOM Saved!', 'success');
              closeForm();
              loadBOMList();
          } else {
              Swal.fire('Error', res.message, 'error');
          }
      }).api_saveBOM({ header, details });
  });

</script>

</body>
</html>
