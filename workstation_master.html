<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    body { background-color: #f4f6f8; font-family: 'Segoe UI', Roboto, sans-serif; }
    .module-container { max-width: 1000px; margin: 0 auto; padding: 20px; padding-bottom: 80px; }
    
    /* Card Styles */
    .card { border-radius: 8px; border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
    .card-title { font-weight: 700; color: #37474f; }

    /* Table */
    table.striped > tbody > tr:nth-child(odd) { background-color: #fafafa; }
    th { color: #546e7a; font-weight: 600; }
    
    /* Inputs */
    input:not([type]), input[type=text]:not(.browser-default) { border-bottom: 1px solid #cfd8dc; }
    input:focus:not([type]), input[type=text]:focus:not(.browser-default) { border-bottom: 1px solid #00897b; box-shadow: 0 1px 0 0 #00897b; }

    /* Views Logic */
    #listView, #formView { display: none; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .status-active { color: #2e7d32; font-weight: bold; background: #e8f5e9; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; }
    .status-maintenance { color: #f57f17; font-weight: bold; background: #fff8e1; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; }
    .status-inactive { color: #c62828; font-weight: bold; background: #ffebee; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; }
  </style>
</head>
<body>

<div class="module-container">

  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
     <div>
       <h5 style="margin:0; font-weight:700; color:#37474f;">Work Station Master</h5>
       <span class="grey-text">Machine & Equipment Register</span>
     </div>
     <button class="btn btn-large teal lighten-1 waves-effect waves-light" onclick="openCreate()">
       <i class="material-icons left">add</i> New Machine
     </button>
  </div>

  <div id="listView" class="card" style="padding:20px;">
     <div class="row">
        <div class="col s12 m6">
           <div class="input-field">
              <i class="material-icons prefix">search</i>
              <input id="search-input" type="text" onkeyup="filterTable()" placeholder="Search Code, Name, Type...">
           </div>
        </div>
     </div>
     <div style="overflow-x:auto;">
       <table class="striped centered">
         <thead>
           <tr>
             <th>Code</th>
             <th class="left-align">Name</th>
             <th>Type</th>
             <th>Model</th>
             <th>Capacity/Hr</th>
             <th>Status</th>
             <th>Action</th>
           </tr>
         </thead>
         <tbody id="ws-tbody"></tbody>
       </table>
     </div>
  </div>

  <div id="formView" class="card" style="padding:0; overflow:hidden;">
     <div style="padding: 20px 30px; background: #eceff1; display:flex; justify-content:space-between; border-bottom:1px solid #ddd;">
        <h5 id="formHeader" style="margin:0; font-weight:700; color:#455a64;">Register New Machine</h5>
        <button class="btn-flat red-text waves-effect" onclick="closeForm()">Cancel</button>
     </div>

     <div style="padding: 30px;">
        <input type="hidden" id="edit-id">
        
        <div class="row">
           <div class="col s12 m4">
              <label>Machine Code (Station Code) *</label>
              <div style="display:flex;">
                 <input id="w-code" type="text" style="text-transform:uppercase; font-weight:bold;">
                 <button class="btn-small teal lighten-2" onclick="checkCode()" style="margin-left:5px;"><i class="material-icons">search</i></button>
              </div>
              <span id="code-helper" class="helper-text" style="min-height:20px; display:block;"></span>
           </div>
           <div class="col s12 m8">
              <label>Machine Name *</label>
              <input id="w-name" type="text">
           </div>
        </div>

        <div class="row" style="background:#f9fbe7; padding:20px; border-radius:8px;">
           <div class="col s12 m4">
              <label>Machine Type</label>
              <select id="w-type" class="browser-default" style="background:white; border:1px solid #ccc;">
                 <option value="" disabled selected>Select Type</option>
                 <option value="Mixing">Mixing (เครื่องผสม)</option>
                 <option value="Filling">Filling (เครื่องบรรจุ)</option>
                 <option value="Packing">Packing (เครื่องแพ็ค)</option>
                 <option value="Labelling">Labelling (ติดฉลาก)</option>
                 <option value="Inspection">Inspection (ตรวจสอบ)</option>
                 <option value="Other">Other</option>
              </select>
           </div>
           
           <div class="col s12 m4">
              <label>Model / Brand</label>
              <input id="w-model" type="text" placeholder="ex. Brand X - Model V2">
           </div>

           <div class="col s12 m4">
              <label>Status</label>
              <select id="w-status" class="browser-default" style="background:white; border:1px solid #ccc;">
                 <option value="Active">Active (พร้อมใช้งาน)</option>
                 <option value="Maintenance">Maintenance (ซ่อมบำรุง)</option>
                 <option value="Inactive">Inactive (เลิกใช้งาน)</option>
              </select>
           </div>
        </div>

        <div class="row" style="margin-top:20px;">
           <div class="col s12 m6">
              <label>Capacity per Hour (ความสามารถในการผลิต/ชม.)</label>
              <input id="w-capacity" type="text" placeholder="ex. 1000 PCS or 500 KG">
              <span class="helper-text grey-text">ระบุตัวเลขและหน่วย (เพื่อใช้อ้างอิงการวางแผน)</span>
           </div>
        </div>

        <div class="divider" style="margin:30px 0;"></div>
        
        <button id="btnSave" class="btn-large teal darken-1 w-100 waves-effect waves-light" style="width:100%;">
           <i class="material-icons left">save</i> Save Work Station
        </button>
     </div>
  </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  let allStations = [];

  document.addEventListener('DOMContentLoaded', () => {
     M.AutoInit();
     loadTable();
  });

  // --- Load Data ---
  function loadTable() {
     const tbody = document.getElementById('ws-tbody');
     tbody.innerHTML = '<tr><td colspan="7">Loading...</td></tr>';
     
     google.script.run.withSuccessHandler(data => {
        allStations = data;
        renderTable(data);
        document.getElementById('listView').style.display = 'block';
     }).api_getAllWorkStations();
  }

  function renderTable(data) {
     const tbody = document.getElementById('ws-tbody');
     tbody.innerHTML = '';
     if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="7">No Work Station Found</td></tr>'; return; }

     data.forEach(item => {
        const tr = document.createElement('tr');
        tr.dataset.json = JSON.stringify(item);
        
        // Status Class
        let statusClass = 'status-active';
        if(item.status === 'Maintenance') statusClass = 'status-maintenance';
        if(item.status === 'Inactive') statusClass = 'status-inactive';

        tr.innerHTML = `
           <td><b>${item.code}</b></td>
           <td class="left-align">${item.name}</td>
           <td>${item.type}</td>
           <td>${item.model}</td>
           <td>${item.capacity}</td>
           <td><span class="${statusClass}">${item.status}</span></td>
           <td>
              <button class="btn-small btn-flat" onclick="editStation(this)">
                 <i class="material-icons blue-text">edit</i>
              </button>
           </td>
        `;
        tbody.appendChild(tr);
     });
  }

  // --- Search ---
  function filterTable() {
     const input = document.getElementById('search-input').value.toUpperCase();
     const filtered = allStations.filter(item => 
        item.code.toUpperCase().includes(input) || 
        item.name.toUpperCase().includes(input) ||
        item.type.toUpperCase().includes(input)
     );
     renderTable(filtered);
  }

  // --- Form Logic ---
  function openCreate() {
     resetForm();
     document.getElementById('listView').style.display = 'none';
     document.getElementById('formView').style.display = 'block';
  }

  function closeForm() {
     document.getElementById('formView').style.display = 'none';
     document.getElementById('listView').style.display = 'block';
  }

  function resetForm() {
     document.getElementById('edit-id').value = '';
     document.querySelectorAll('input').forEach(i => i.value = '');
     document.getElementById('w-status').value = 'Active';
     document.getElementById('w-type').selectedIndex = 0;
     document.getElementById('code-helper').innerText = '';
     document.getElementById('formHeader').innerText = 'Register New Machine';
     document.getElementById('btnSave').innerHTML = '<i class="material-icons left">save</i> Save Work Station';
  }

  window.editStation = function(btn) {
     const item = JSON.parse(btn.closest('tr').dataset.json);
     
     document.getElementById('edit-id').value = item.id;
     document.getElementById('w-code').value = item.code;
     document.getElementById('w-name').value = item.name;
     document.getElementById('w-type').value = item.type;
     document.getElementById('w-model').value = item.model;
     document.getElementById('w-capacity').value = item.capacity;
     document.getElementById('w-status').value = item.status;

     document.getElementById('formHeader').innerText = 'Edit: ' + item.code;
     document.getElementById('btnSave').innerHTML = '<i class="material-icons left">save</i> Update Work Station';

     document.getElementById('listView').style.display = 'none';
     document.getElementById('formView').style.display = 'block';
     M.updateTextFields();
  };

  function checkCode() {
     const code = document.getElementById('w-code').value.trim();
     const helper = document.getElementById('code-helper');
     if(!code) { M.toast({html:'Enter code'}); return; }
     
     helper.innerText = 'Checking...';
     google.script.run.withSuccessHandler(res => {
        if(res.status === 'AVAILABLE') {
           helper.innerText = '✅ Available'; helper.style.color = 'green';
        } else {
           helper.innerText = '❌ Duplicate!'; helper.style.color = 'red';
        }
     }).api_checkStationCode(code);
  }

  // --- Save ---
  document.getElementById('btnSave').addEventListener('click', function() {
     const id = document.getElementById('edit-id').value;
     const code = document.getElementById('w-code').value.trim();
     const name = document.getElementById('w-name').value.trim();
     
     if(!code || !name) { Swal.fire('Error', 'Code & Name Required', 'error'); return; }

     const data = {
        id: id,
        code: code,
        name: name,
        type: document.getElementById('w-type').value,
        model: document.getElementById('w-model').value,
        capacity: document.getElementById('w-capacity').value,
        status: document.getElementById('w-status').value
     };

     const btn = this; btn.disabled = true; btn.innerText = 'Saving...';

     google.script.run.withSuccessHandler(res => {
        btn.disabled = false; btn.innerText = 'Save Work Station';
        if(res.success) {
           Swal.fire('Success', res.message, 'success');
           closeForm();
           loadTable();
        } else {
           Swal.fire('Error', res.message, 'error');
        }
     }).api_saveWorkStation(data);
  });

</script>

</body>
</html>
