<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    /* CSS เดิม */
    body { background-color: #f4f6f8; font-family: 'Segoe UI', Roboto, sans-serif; }
    .module-container { max-width: 1000px; margin: 0 auto; padding: 20px; padding-bottom: 80px; }
    .card { border-radius: 8px; border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
    table.striped > tbody > tr:nth-child(odd) { background-color: #fafafa; }
    th { color: #546e7a; font-weight: 600; }
    input:not([type]), input[type=text]:not(.browser-default), input[type=number]:not(.browser-default) { border-bottom: 1px solid #cfd8dc; }
    #listView, #formView { display: none; }
    .status-active { color: #2e7d32; background: #e8f5e9; padding: 2px 8px; border-radius: 4px; font-weight:bold; }
    .status-inactive { color: #c62828; background: #ffebee; padding: 2px 8px; border-radius: 4px; font-weight:bold; }
    .status-maintenance { color: #ef6c00; background: #fff3e0; padding: 2px 8px; border-radius: 4px; font-weight:bold; }
  </style>
</head>
<body>

<div class="module-container">

  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
     <div>
       <h5 style="margin:0; font-weight:700; color:#37474f;">Work Station Master (Rev.02)</h5>
       <span class="grey-text">Machine Register & Capacity</span>
     </div>
     <button class="btn btn-large teal lighten-1 waves-effect" onclick="openCreate()">
       <i class="material-icons left">add</i> New Machine
     </button>
  </div>

  <div id="listView" class="card" style="padding:20px;">
     <div class="input-field" style="max-width:300px;">
        <i class="material-icons prefix">search</i>
        <input id="search-input" type="text" onkeyup="filterTable()" placeholder="Search Code, Name...">
     </div>
     <div style="overflow-x:auto;">
       <table class="striped centered">
         <thead>
           <tr>
             <th>Code</th>
             <th class="left-align">Name</th>
             <th>Type</th>
             <th>Model</th>
             <th>Capacity / Hour</th> <th>Status</th>
             <th>Action</th>
           </tr>
         </thead>
         <tbody id="ws-tbody"></tbody>
       </table>
     </div>
  </div>

  <div id="formView" class="card" style="padding:0; overflow:hidden;">
     <div style="padding: 20px 30px; background: #eceff1; display:flex; justify-content:space-between; border-bottom:1px solid #ddd;">
        <h5 id="formHeader" style="margin:0; font-weight:700; color:#455a64;">Register New Machine</h5>
        <button class="btn-flat red-text waves-effect" onclick="closeForm()">Cancel</button>
     </div>

     <div style="padding: 30px;">
        <input type="hidden" id="edit-id">
        
        <div class="row">
           <div class="col s12 m4">
              <label>Machine Code *</label>
              <div style="display:flex;">
                 <input id="w-code" type="text" style="text-transform:uppercase; font-weight:bold;">
                 <button class="btn-small teal lighten-2" onclick="checkCode()" style="margin-left:5px;"><i class="material-icons">search</i></button>
              </div>
              <span id="code-helper" class="helper-text" style="min-height:20px; display:block;"></span>
           </div>
           <div class="col s12 m8">
              <label>Machine Name *</label>
              <input id="w-name" type="text">
           </div>
        </div>

        <div class="row" style="background:#f9fbe7; padding:20px; border-radius:8px;">
           <div class="col s12 m4">
              <label>Machine Type</label>
              <select id="w-type" class="browser-default" style="background:white; border:1px solid #ccc;">
                 <option value="" disabled selected>Select Type</option>
                 <option value="Mixing">Mixing</option>
                 <option value="Filling">Filling</option>
                 <option value="Packing">Packing</option>
                 <option value="Labelling">Labelling</option>
                 <option value="Inspection">Inspection</option>
                 <option value="Other">Other</option>
              </select>
           </div>
           <div class="col s12 m4">
              <label>Model / Brand</label>
              <input id="w-model" type="text">
           </div>
           <div class="col s12 m4">
              <label>Status</label>
              <select id="w-status" class="browser-default" style="background:white; border:1px solid #ccc;">
                 <option value="Active">Active</option>
                 <option value="Maintenance">Maintenance</option>
                 <option value="Inactive">Inactive</option>
              </select>
           </div>
        </div>

        <div class="row" style="margin-top:20px; background:#e0f2f1; padding:20px; border-radius:8px;">
           <div class="col s12"><h6 class="teal-text" style="margin-top:0;">Production Capacity</h6></div>
           
           <div class="col s12 m6">
              <label>Capacity per Hour (ระบุเฉพาะตัวเลข)</label>
              <input id="w-capacity" type="number" placeholder="e.g. 1000"> 
           </div>
           
           <div class="col s12 m6">
              <label>Unit of Measure (UOM)</label>
              <select id="w-capacity-uom" class="browser-default" style="background:white; border:1px solid #ccc;">
                  <option value="" disabled selected>Select UOM</option>
                  <option value="PCS">PCS (ชิ้น)</option>
                  <option value="KGS">KGS (กิโลกรัม)</option>
                  <option value="BOT">BOT (ขวด)</option>
                  <option value="SET">SET (ชุด)</option>
                  <option value="BOX">BOX (กล่อง)</option>
                  <option value="LTR">LTR (ลิตร)</option>
              </select>
           </div>
        </div>

        <div class="divider" style="margin:30px 0;"></div>
        <button id="btnSave" class="btn-large teal darken-1 w-100 waves-effect waves-light" style="width:100%;">
           <i class="material-icons left">save</i> Save Work Station
        </button>
     </div>
  </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  let allStations = [];

  document.addEventListener('DOMContentLoaded', () => { M.AutoInit(); loadTable(); });

  // --- Load & Render ---
  function loadTable() {
     const tbody = document.getElementById('ws-tbody');
     tbody.innerHTML = '<tr><td colspan="7">Loading...</td></tr>';
     
     google.script.run.withSuccessHandler(data => {
        allStations = data;
        renderTable(data);
        document.getElementById('listView').style.display = 'block';
     }).api_getAllWorkStations();
  }

  function renderTable(data) {
     const tbody = document.getElementById('ws-tbody');
     tbody.innerHTML = '';
     if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="7">No Data</td></tr>'; return; }

     data.forEach(item => {
        const tr = document.createElement('tr');
        tr.dataset.json = JSON.stringify(item);
        
        let statusClass = 'status-active';
        if(item.status === 'Maintenance') statusClass = 'status-maintenance';
        if(item.status === 'Inactive') statusClass = 'status-inactive';

        // แสดงผลรวม Capacity + UOM
        const capDisplay = (item.capacity > 0) ? `<b>${item.capacity}</b> <span class="grey-text">${item.capacityUOM || ''}</span>` : '-';

        tr.innerHTML = `
           <td><b>${item.code}</b></td>
           <td class="left-align">${item.name}</td>
           <td>${item.type}</td>
           <td>${item.model}</td>
           <td>${capDisplay}</td> 
           <td><span class="${statusClass}">${item.status}</span></td>
           <td>
              <button class="btn-small btn-flat" onclick="editStation(this)">
                 <i class="material-icons blue-text">edit</i>
              </button>
           </td>
        `;
        tbody.appendChild(tr);
     });
  }

  // --- Search ---
  function filterTable() {
     const input = document.getElementById('search-input').value.toUpperCase();
     const filtered = allStations.filter(item => 
        item.code.toUpperCase().includes(input) || item.name.toUpperCase().includes(input)
     );
     renderTable(filtered);
  }

  // --- UI Logic ---
  function openCreate() {
     resetForm();
     document.getElementById('listView').style.display = 'none';
     document.getElementById('formView').style.display = 'block';
  }
  function closeForm() {
     document.getElementById('formView').style.display = 'none';
     document.getElementById('listView').style.display = 'block';
  }
  function resetForm() {
     document.getElementById('edit-id').value = '';
     document.querySelectorAll('input').forEach(i => i.value = '');
     document.getElementById('w-status').value = 'Active';
     document.getElementById('w-type').selectedIndex = 0;
     document.getElementById('w-capacity-uom').selectedIndex = 0; // Reset UOM
     document.getElementById('code-helper').innerText = '';
     document.getElementById('formHeader').innerText = 'Register New Machine';
     document.getElementById('btnSave').innerText = 'Save Work Station';
  }

  // --- Edit Logic ---
  window.editStation = function(btn) {
     const item = JSON.parse(btn.closest('tr').dataset.json);
     
     document.getElementById('edit-id').value = item.id;
     document.getElementById('w-code').value = item.code;
     document.getElementById('w-name').value = item.name;
     document.getElementById('w-type').value = item.type;
     document.getElementById('w-model').value = item.model;
     document.getElementById('w-status').value = item.status;
     
     // Set Capacity & UOM
     document.getElementById('w-capacity').value = item.capacity;
     document.getElementById('w-capacity-uom').value = item.capacityUOM || '';

     document.getElementById('formHeader').innerText = 'Edit: ' + item.code;
     document.getElementById('btnSave').innerText = 'Update Work Station';

     document.getElementById('listView').style.display = 'none';
     document.getElementById('formView').style.display = 'block';
     M.updateTextFields();
  };

  // --- Save Logic ---
  document.getElementById('btnSave').addEventListener('click', function() {
     const id = document.getElementById('edit-id').value;
     const code = document.getElementById('w-code').value.trim();
     const name = document.getElementById('w-name').value.trim();
     
     if(!code || !name) { Swal.fire('Error', 'Code & Name Required', 'error'); return; }

     const data = {
        id: id,
        code: code,
        name: name,
        type: document.getElementById('w-type').value,
        model: document.getElementById('w-model').value,
        status: document.getElementById('w-status').value,
        // Capacity Data
        capacity: document.getElementById('w-capacity').value,
        capacityUOM: document.getElementById('w-capacity-uom').value
     };

     const btn = this; btn.disabled = true; btn.innerText = 'Saving...';

     google.script.run.withSuccessHandler(res => {
        btn.disabled = false; btn.innerText = 'Save Work Station';
        if(res.success) {
           Swal.fire('Success', res.message, 'success');
           closeForm();
           loadTable();
        } else {
           Swal.fire('Error', res.message, 'error');
        }
     }).api_saveWorkStation(data);
  });
  
  // Check Duplicate Code
  function checkCode() { /* Logic เดิม เหมือน Rev.01 */ 
     const code = document.getElementById('w-code').value.trim();
     const helper = document.getElementById('code-helper');
     if(!code) return;
     helper.innerText = 'Checking...';
     google.script.run.withSuccessHandler(res => {
        if(res.status === 'AVAILABLE') {
           helper.innerText = '✅ Available'; helper.style.color = 'green';
        } else {
           helper.innerText = '❌ Duplicate!'; helper.style.color = 'red';
        }
     }).api_checkStationCode(code);
  }
</script>

</body>
</html>
